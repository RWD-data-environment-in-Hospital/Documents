<!DOCTYPE html>
<html>
<head>
<title>HADES_function.md</title>
<meta http-equiv="Content-type" content="text/html;charset=UTF-8">
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.4/css/all.css">

<style>
/* https://github.com/microsoft/vscode/blob/master/extensions/markdown-language-features/media/markdown.css */
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

body {
	font-family: var(--vscode-markdown-font-family, -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif);
	font-size: var(--vscode-markdown-font-size, 16px);
	padding: 0 26px;
	line-height: var(--vscode-markdown-line-height, 22px);
	word-wrap: break-word;
}

#code-csp-warning {
	position: fixed;
	top: 0;
	right: 0;
	color: white;
	margin: 16px;
	text-align: center;
	font-size: 12px;
	font-family: sans-serif;
	background-color:#444444;
	cursor: pointer;
	padding: 6px;
	box-shadow: 1px 1px 1px rgba(0,0,0,.25);
}

#code-csp-warning:hover {
	text-decoration: none;
	background-color:#007acc;
	box-shadow: 2px 2px 2px rgba(0,0,0,.25);
}

body.scrollBeyondLastLine {
	margin-bottom: calc(100vh - 22px);
}

body.showEditorSelection .code-line {
	position: relative;
}

body.showEditorSelection .code-active-line:before,
body.showEditorSelection .code-line:hover:before {
	content: "";
	display: block;
	position: absolute;
	top: 0;
	left: -12px;
	height: 100%;
}

body.showEditorSelection li.code-active-line:before,
body.showEditorSelection li.code-line:hover:before {
	left: -30px;
}

.vscode-light.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(0, 0, 0, 0.15);
}

.vscode-light.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(0, 0, 0, 0.40);
}

.vscode-light.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-dark.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 255, 255, 0.4);
}

.vscode-dark.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 255, 255, 0.60);
}

.vscode-dark.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-high-contrast.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 160, 0, 0.7);
}

.vscode-high-contrast.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 160, 0, 1);
}

.vscode-high-contrast.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

p, pre {
	width: 90%; max-width: 1200px;
}

ol{
	width: 90%; max-width: 1200px;
	/* text-indent:-50px;margin-left: 70px; */
}

li{
	width: 90%; max-width: 1200px;
	/* text-indent:-50px;margin-left: 70px; */
}

pre code {
	color: var(--vscode-editor-foreground);
	font-size: 16px;
	tab-size: 4;
}

/* img {
	max-width: 100%;
	max-height: 100%;
} */

a {
	text-decoration: none;
}

a:hover {
	text-decoration: underline;
}

a:focus,
input:focus,
select:focus,
textarea:focus {
	outline: 1px solid -webkit-focus-ring-color;
	outline-offset: -1px;
}

hr {
	border: 0;
	height: 2px;
	border-bottom: 2px solid;
}

h1 {
	padding-bottom: 0.3em;
	line-height: 1.2;
	border-bottom-width: 1px;
	border-bottom-style: solid;
}

h1, h2, h3 {
	font-weight: normal;
}

table {
	border-collapse: collapse;
}

table > thead > tr > th {
	text-align: left;
	border-bottom: 1px solid;
}

table > thead > tr > th,
table > thead > tr > td,
table > tbody > tr > th,
table > tbody > tr > td {
	padding: 5px 10px;
}

table > tbody > tr + tr > td {
	border-top: 1px solid;
}

blockquote {
	margin: 0 7px 0 5px;
	padding: 0 16px 0 10px;
	border-left-width: 5px;
	border-left-style: solid;
}

code {
	font-family: Menlo, Monaco, Consolas, "Droid Sans Mono", "Courier New", monospace, "Droid Sans Fallback";
	font-size: 1em;
	line-height: 1.357em;
}

body.wordWrap pre {
	white-space: pre-wrap;
}

pre:not(.hljs),
pre.hljs code > div {
	padding: 16px;
	border-radius: 3px;
	overflow: auto;
}

pre code {
	color: var(--vscode-editor-foreground);
	tab-size: 4;
}

/** Theming */

.vscode-light pre {
	background-color: rgba(220, 220, 220, 0.4);
}

.vscode-dark pre {
	background-color: rgba(10, 10, 10, 0.4);
}

.vscode-high-contrast pre {
	background-color: rgb(0, 0, 0);
}

.vscode-high-contrast h1 {
	border-color: rgb(0, 0, 0);
}

.vscode-light table > thead > tr > th {
	border-color: rgba(0, 0, 0, 0.69);
}

.vscode-dark table > thead > tr > th {
	border-color: rgba(255, 255, 255, 0.69);
}

.vscode-light h1,
.vscode-light hr,
.vscode-light table > tbody > tr + tr > td {
	border-color: rgba(0, 0, 0, 0.18);
}

.vscode-dark h1,
.vscode-dark hr,
.vscode-dark table > tbody > tr + tr > td {
	border-color: rgba(255, 255, 255, 0.18);
}

</style>

<style>
/* Tomorrow Theme */
/* http://jmblog.github.com/color-themes-for-google-code-highlightjs */
/* Original theme - https://github.com/chriskempson/tomorrow-theme */

/* Tomorrow Comment */
.hljs-comment,
.hljs-quote {
	color: #8e908c;
}

/* Tomorrow Red */
.hljs-variable,
.hljs-template-variable,
.hljs-tag,
.hljs-name,
.hljs-selector-id,
.hljs-selector-class,
.hljs-regexp,
.hljs-deletion {
	color: #c82829;
}

/* Tomorrow Orange */
.hljs-number,
.hljs-built_in,
.hljs-builtin-name,
.hljs-literal,
.hljs-type,
.hljs-params,
.hljs-meta,
.hljs-link {
	color: #f5871f;
}

/* Tomorrow Yellow */
.hljs-attribute {
	color: #eab700;
}

/* Tomorrow Green */
.hljs-string,
.hljs-symbol,
.hljs-bullet,
.hljs-addition {
	color: #718c00;
}

/* Tomorrow Blue */
.hljs-title,
.hljs-section {
	color: #4271ae;
}

/* Tomorrow Purple */
.hljs-keyword,
.hljs-selector-tag {
	color: #8959a8;
}

.hljs {
	display: block;
	overflow-x: auto;
	color: #4d4d4c;
	padding: 0.5em;
}

.hljs-emphasis {
	font-style: italic;
}

.hljs-strong {
	font-weight: bold;
}
</style>

<style>
/*
 * Markdown PDF CSS
 */

 body {
	font-family: -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif, "Meiryo";
	padding: 0 12px;
}

pre {
	background-color: #f8f8f8;
	border: 1px solid #cccccc;
	border-radius: 3px;
	overflow-x: auto;
	white-space: pre-wrap;
	overflow-wrap: break-word;
}

pre:not(.hljs),
pre.hljs code > div {
	font-family: Meiryo;
	padding: 16px;
	border-radius: 3px;
	overflow: auto;
}

/* pre:not(.hljs) {
	padding: 23px;
	line-height: 19px;
} */

blockquote {
	background: rgba(127, 127, 127, 0.1);
	border-color: rgba(0, 122, 204, 0.5);
}

.emoji {
	height: 1.4em;
}

code {
	font-size: 14px;
	line-height: 19px;
}

/* for inline code */
:not(pre):not(.hljs) > code {
	color: #C9AE75; /* Change the old color so it seems less like an error */
	font-size: inherit;
}

/* Page Break : use <div class="page"/> to insert page break
-------------------------------------------------------- */
.page {
	page-break-after: always;
}

/* ページトップへ移動ボタン */
#page_top{
  width: 90px;
  height: 90px;
  position: fixed;
  right: 15px;
  bottom: 15px;
  background: #3f98ef;
  opacity: 0.6;
  border-radius: 50%;
}
#page_top a{
  position: relative;
  display: block;
  width: 90px;
  height: 90px;
  text-decoration: none;
}
#page_top a::before{
  font-family: 'Font Awesome 5 Free';
  font-weight: 900;
  content: '\f102';
  font-size: 25px;
  color: #fff;
  position: absolute;
  width: 25px;
  height: 25px;
  top: -40px;
  bottom: 0;
  right: 0;
  left: 0;
  margin: auto;
  text-align: center;
}
#page_top a::after{
  content: 'PAGE TOP';
  font-size: 13px;
  color: #fff;
  position: absolute;
  top: 45px;
  bottom: 0;
  right: 0;
  left: 0;
  margin: auto;
  text-align: center;
}

html{
  scroll-behavior: smooth;
}

/* 吹き出し本体 */
.balloon{
  position: relative;
  padding: 20px;
  background-color: #b1ccee;
  display: inline-block;     /* 横幅を自動で変更 */
  border-radius: 10px;         /* 角丸を指定 */
}

/* 吹き出しの矢印 */
.balloon::after{
  content: '';
  position: absolute;
  display: block;
  width: 0;
  height: 0;
  left: -12px;
  top: 20px;
  border-right: 15px solid #b1ccee;
  border-top: 15px solid transparent;
  border-bottom: 15px solid transparent;
}

/* ------------------------------ */
.base_area_1{
	position: relative;
	border: dotted 2px #000;
	width: 1205px;
	height: 680px;
	background-color: #dbebdf;
	text-align:center;
	font-size: 20px;
}

.base_area_2{
	position: relative;
	border: dotted 2px #000;
	width: 1205px;
	height: 360px;
	background-color: #dbebdf;
	text-align:center;
	font-size: 20px;
}

.base_area_3{
	position: relative;
	border: dotted 2px #000;
	width: 1205px;
	height: 1310px;
	background-color: #dbebdf;
	text-align:center;
	font-size: 20px;
}

.headline_1{
	position: absolute;
  	top: 30px;
  	left: 5px;
  	font-weight: bold;
	border: solid 2px black;
	border-top-left-radius: 10px;
	width: 390px;
	height: 23px;
	background-color: rgb(30, 30, 70);
	color:white;
	text-align:center;
	font-size: 18px;
	/* padding: 1px 0px 0px 10px; */
}

.letter_1{
	position: absolute;
  	top: 57px;
  	left: 5px;
	border: solid 2px black;
	width: 394px;
	height: 285px;
	background-color: white;
	text-align:left;
	font-size: 12px;
	padding: 0px 0px 0px 10px;
	box-sizing: border-box;
}

.headline_2{
	position: absolute;
  	top: 30px;
  	left: 405px;
  	font-weight: bold;
	border: solid 2px black;
	border-top-left-radius: 10px;
	width: 380px;
	height: 23px;
	background-color: rgb(30, 30, 70);
	color:white;
	text-align:center;
	font-size: 18px;
	padding: 1px 0px 0px 10px;
}

.letter_2{
	position: absolute;
  	top: 58px;
  	left: 405px;
	border: solid 2px black;
	width: 380px;
	height: 280px;
	background-color: white;
	text-align:left;
	font-size: 12px;
	padding: 0px 0px 0px 10px;
}

.headline_3{
	position: absolute;
  	top: 30px;
  	left: 805px;
  	font-weight: bold;
	border: solid 2px black;
	border-top-left-radius: 10px;
	width: 380px;
	height: 23px;
	background-color: rgb(30, 30, 70);
	color:white;
	text-align:center;
	font-size: 18px;
	padding: 1px 0px 0px 10px;
}

.letter_3{
	position: absolute;
  	top: 58px;
  	left: 805px;
	border: solid 2px black;
	width: 380px;
	height: 280px;
	background-color: white;
	text-align:left;
	font-size: 12px;
	padding: 0px 0px 0px 10px;
}

.headline_4{
	position: absolute;
  	top: 350px;
  	left: 5px;
  	font-weight: bold;
	border: solid 2px black;
	border-top-left-radius: 10px;
	width: 380px;
	height: 23px;
	background-color: rgb(30, 30, 70);
	color:white;
	text-align:center;
	font-size: 18px;
	padding: 1px 0px 0px 10px;
}

.letter_4{
	position: absolute;
  	top: 378px;
  	left: 5px;
	border: solid 2px black;
	width: 380px;
	height: 280px;
	background-color: white;
	text-align:left;
	font-size: 12px;
	padding: 0px 0px 0px 10px;
}

.headline_5{
	position: absolute;
  	top: 350px;
  	left: 405px;
  	font-weight: bold;
	border: solid 2px black;
	border-top-left-radius: 10px;
	width: 380px;
	height: 23px;
	background-color: rgb(30, 30, 70);
	color:white;
	text-align:center;
	font-size: 18px;
	padding: 1px 0px 0px 10px;
}

.letter_5{
	position: absolute;
  	top: 378px;
  	left: 405px;
	border: solid 2px black;
	width: 380px;
	height: 280px;
	background-color: white;
	text-align:left;
	font-size: 12px;
	padding: 0px 0px 0px 10px;
}

.headline_6{
	position: absolute;
  	top: 350px;
  	left: 805px;
  	font-weight: bold;
	border: solid 2px black;
	border-top-left-radius: 10px;
	width: 380px;
	height: 23px;
	background-color: rgb(30, 30, 70);
	color:white;
	text-align:center;
	font-size: 18px;
	padding: 1px 0px 0px 10px;
}

.letter_6{
	position: absolute;
  	top: 378px;
  	left: 805px;
	border: solid 2px black;
	width: 380px;
	height: 280px;
	background-color: white;
	text-align:left;
	font-size: 12px;
	padding: 0px 0px 0px 10px;
}

.headline_7{
	position: absolute;
  	top: 670px;
  	left: 5px;
  	font-weight: bold;
	border: solid 2px black;
	border-top-left-radius: 10px;
	width: 380px;
	height: 23px;
	background-color: rgb(30, 30, 70);
	color:white;
	text-align:center;
	font-size: 18px;
	padding: 1px 0px 0px 10px;
}

.letter_7{
	position: absolute;
  	top: 698px;
  	left: 5px;
	border: solid 2px black;
	width: 380px;
	height: 280px;
	background-color: white;
	text-align:left;
	font-size: 12px;
	padding: 0px 0px 0px 10px;
}

.headline_8{
	position: absolute;
  	top: 670px;
  	left: 405px;
  	font-weight: bold;
	border: solid 2px black;
	border-top-left-radius: 10px;
	width: 380px;
	height: 23px;
	background-color: rgb(30, 30, 70);
	color:white;
	text-align:center;
	font-size: 18px;
	padding: 1px 0px 0px 10px;
}

.letter_8{
	position: absolute;
  	top: 698px;
  	left: 405px;
	border: solid 2px black;
	width: 380px;
	height: 280px;
	background-color: white;
	text-align:left;
	font-size: 12px;
	padding: 0px 0px 0px 10px;
}

.headline_9{
	position: absolute;
  	top: 670px;
  	left: 805px;
  	font-weight: bold;
	border: solid 2px black;
	border-top-left-radius: 10px;
	width: 380px;
	height: 23px;
	background-color: rgb(30, 30, 70);
	color:white;
	text-align:center;
	font-size: 18px;
	padding: 1px 0px 0px 10px;
}

.letter_9{
	position: absolute;
  	top: 698px;
  	left: 805px;
	border: solid 2px black;
	width: 380px;
	height: 280px;
	background-color: white;
	text-align:left;
	font-size: 12px;
	padding: 0px 0px 0px 10px;
}

.headline_10{
	position: absolute;
  	top: 990px;
  	left: 5px;
  	font-weight: bold;
	border: solid 2px black;
	border-top-left-radius: 10px;
	width: 380px;
	height: 23px;
	background-color: rgb(30, 30, 70);
	color:white;
	text-align:center;
	font-size: 18px;
	padding: 1px 0px 0px 10px;
}

.letter_10{
	position: absolute;
  	top: 1018px;
  	left: 5px;
	border: solid 2px black;
	width: 380px;
	height: 280px;
	background-color: white;
	text-align:left;
	font-size: 12px;
	padding: 0px 0px 0px 10px;
}

.headline_11{
	position: absolute;
  	top: 990px;
  	left: 405px;
  	font-weight: bold;
	border: solid 2px black;
	border-top-left-radius: 10px;
	width: 380px;
	height: 23px;
	background-color: rgb(30, 30, 70);
	color:white;
	text-align:center;
	font-size: 18px;
	padding: 1px 0px 0px 10px;
}

.letter_11{
	position: absolute;
  	top: 1018px;
  	left: 405px;
	border: solid 2px black;
	width: 380px;
	height: 280px;
	background-color: white;
	text-align:left;
	font-size: 12px;
	padding: 0px 0px 0px 10px;
}

.headline_12{
	position: absolute;
  	top: 990px;
  	left: 805px;
  	font-weight: bold;
	border: solid 2px black;
	border-top-left-radius: 10px;
	width: 380px;
	height: 23px;
	background-color: rgb(30, 30, 70);
	color:white;
	text-align:center;
	font-size: 18px;
	padding: 1px 0px 0px 10px;
}

.letter_12{
	position: absolute;
  	top: 1018px;
  	left: 805px;
	border: solid 2px black;
	width: 380px;
	height: 280px;
	background-color: white;
	text-align:left;
	font-size: 12px;
	padding: 0px 0px 0px 10px;
}
</style>

<script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
</head>
<body>
  <script>
    mermaid.initialize({
      startOnLoad: true,
      theme: document.body.classList.contains('vscode-dark') || document.body.classList.contains('vscode-high-contrast')
          ? 'dark'
          : 'default'
    });
  </script>
<body>
<div id="page_top"><a href="#"></a></div>
<h1 id="hades%E3%83%91%E3%83%83%E3%82%B1%E3%83%BC%E3%82%B8%E6%A6%82%E8%A6%81"><strong>HADESパッケージ概要</strong></h1>
<p><img src="./HADES_2/image/image1.jpg" alt="" width="600"></p>
<br>
<h2 id="%E7%9B%AE%E6%AC%A1"><strong>目次</strong></h2>
<p><a href="#1%E6%9C%AC%E6%9B%B8%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6">1．本書について</a><br>
<a href="#2%E5%8F%82%E8%80%83%E8%B3%87%E6%96%99">2．参考資料</a><br>
<a href="#3cohortmethod-%E5%87%A6%E7%90%86%E3%81%AE%E6%B5%81%E3%82%8C">3．CohortMethod 処理の流れ</a><br>
<a href="#4%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E6%8A%BD%E5%87%BA%E3%83%BB%E8%AA%BF%E6%9F%BB%E5%AF%BE%E8%B1%A1%E3%83%87%E3%83%BC%E3%82%BF%E3%83%A2%E3%83%87%E3%83%AB%E3%81%AE%E4%BD%9C%E6%88%90">4．データの抽出・調査対象データモデルの作成</a><br>
<a href="#5%E8%AA%BF%E6%9F%BB%E5%AF%BE%E8%B1%A1%E9%9B%86%E5%9B%A3%E3%81%AE%E5%AE%9A%E7%BE%A9">5．調査対象集団の定義</a><br>
<a href="#6%E5%82%BE%E5%90%91%E3%82%B9%E3%82%B3%E3%82%A2%E5%88%86%E6%9E%90">6．傾向スコア分析</a><br>
<a href="#7%E5%85%B1%E5%A4%89%E9%87%8F%E3%83%90%E3%83%A9%E3%83%B3%E3%82%B9%E3%81%AE%E8%A9%95%E4%BE%A1">7．共変量バランスの評価</a><br>
<a href="#8%E3%83%95%E3%82%A9%E3%83%AD%E3%83%BC%E3%82%A2%E3%83%83%E3%83%97%E3%81%A8%E6%A4%9C%E5%87%BA%E5%8A%9B">8．フォローアップと検出力</a><br>
<a href="#9%E3%82%A2%E3%82%A6%E3%83%88%E3%82%AB%E3%83%A0%E3%83%A2%E3%83%87%E3%83%AB">9．アウトカムモデル</a></p>
<br>
<hr>
<h1 id="hadeshealth-analytics-data-to-evidence-suite%E3%81%A8%E3%81%AF"><strong>HADES（Health Analytics Data-to-Evidence Suite）とは</strong></h1>
<p>母集団の特性評価、母集団レベルの因果効果の推定、患者レベルの予測など、大規模な分析のための20個のオープンソース R パッケージのセットです。<br>
R パッケージには R 関数が含まれています。<br>
R 関数は、データから推定と統計、図、表のサポートまでの観察研究を実行するために使用できます。<br>
パッケージは CDM の観測データと直接相互作用し、カスタム分析へのクロスプラットフォーム互換性を提供するために使用できます。</p>
<p>HADES を利用した分析では、R の開発スキルが必要です。</p>
<p>HADES に含まれているパッケージは、以下の通りです。本書では、CohortMethod を例として解説します。</p>
<br>
<div class="base_area_1"><strong>Population-level estimation（母集団レベルの推定）</strong>
	<div class="headline_1">CohortMethod</div>
	<div class="letter_1">
		<p>OMOP共通データモデルの観測データベースで<strong>新規ユーザーコホート研究を実行</strong>するための R パッケージです。<br>傾向および結果モデルに大規模回帰を使用します。</p>
		<p>参考URL：<a href="https://ohdsi.github.io/CohortMethod/" target="_blank"  rel="nofollow">https://ohdsi.github.io/CohortMethod/</a></p>
	</div>
	<div class="headline_2">SelfControlledCaseSeries</div>
	<div class="letter_2">
		<p>OMOP 共通データモデルの観測データベースで <strong>Self-Controlled Case Series（SCCS）分析を実行</strong>するための R パッケージです。<br>
			少数または多数の予測子を使用した自己制御のケースシリーズ分析には、年齢と季節性のスプラインが含まれます。</p>
		<p>参考URL：<a href="https://ohdsi.github.io/SelfControlledCaseSeries/" target="_blank"  rel="nofollow">https://ohdsi.github.io/SelfControlledCaseSeries/</a></p>
	</div>
	<div class="headline_3">SelfControlledCohort</div>
	<div class="letter_3">
		<p><strong>曝露されたコホート間で曝露された時間と曝露されていない時間を比較することによってリスクを推定する</strong>方法を提供します。</p>
		<p>参考URL：<a href="https://ohdsi.github.io/SelfControlledCohort/" target="_blank"  rel="nofollow">https://ohdsi.github.io/SelfControlledCohort/</a></p>
	</div>
	<div class="headline_4">EvidenceSynthesis</div>
	<div class="letter_4">
		<p><strong>分散研究で複数のデータサイトにわたる因果効果の推定と研究診断を組み合わせる</strong>ためのルーチン。<br>
		これには、メタ分析とフォレストプロットを実行するための関数が含まれます。</p>
		<p>参考URL：<a href="https://ohdsi.github.io/EvidenceSynthesis/" target="_blank"  rel="nofollow">https://ohdsi.github.io/EvidenceSynthesis/</a></p>
	</div>
</div>
<br>
<div class="base_area_2"><strong>Patient-level prediction（患者レベルの予測）</strong>
	<div class="headline_1">PatientLevelPrediction</div>
	<div class="letter_1">
		<p>OMOP 共通データモデル形式のデータを使用して<strong>患者レベルの予測モデルを構築および検証する</strong>ための R パッケージです。<br>
			多様な機械学習アルゴリズムを使用して、ユーザー指定の結果の予測モデルを構築、評価します。</p>
		<p>参考URL：<a href="https://ohdsi.github.io/PatientLevelPrediction/" target="_blank"  rel="nofollow">https://ohdsi.github.io/PatientLevelPrediction/</a></p>
	</div>
</div>
<br>
<div class="base_area_2"><strong>Evidence Quality（エビデンスの質）</strong>
	<div class="headline_1">EmpiricalCalibration</div>
	<div class="letter_1">
		<p>観察研究の<strong>推定値の経験的推定を行う</strong>ためのルーチンが含まれています。ネガティブコントロール仮説のセットを使用して、<strong>特定の観察研究のセットアップの経験的な帰無分布を推定</strong>することができます。
			この経験的帰無分布は、論文「Interpreting observational studies: why empirical calibration is needed to correct p-values.」で説明されているように、帰無仮説が真であるときにランダムおよびシステマティックエラーの両方を考慮して推定効果サイズを観察する確率を反映した校正されたp-値を計算するために使用できます。 (<a href="http://dx.doi.org/10.1002/sim.5925" target="_blank"  rel="nofollow">http://dx.doi.org/10.1002/sim.5925</a>)を参照してください。</p>
		<p>参考URL：<a href="https://ohdsi.github.io/EmpiricalCalibration/" target="_blank"  rel="nofollow">https://ohdsi.github.io/EmpiricalCalibration/</a></p>
	</div>
	<div class="headline_2">MethodEvaluation</div>
	<div class="letter_2">
		<p><strong>ある結果に対する薬剤の効果の大きさ（相対リスク）を推定することを目的とした手法の性能を評価するためのリソース</strong>が含まれています。<br>
		これらのリソースには、実データ上で手法を評価するためのリファレンスセット や、陰性対照薬とアウトカムのペアに基づいて実データに模擬効果を挿入するための関数が含まれています。<br>
		さらに、検出可能な最小の相対リスクを計算する機能や、予測精度、エラー、バイアスなどの性能統計を計算する機能も含まれています。</p>
		<p>参考URL：<a href="https://ohdsi.github.io/MethodEvaluation/" target="_blank"  rel="nofollow">https://ohdsi.github.io/MethodEvaluation/</a></p>
	</div>
	<div class="headline_3">CohortDiagnostics</div>
	<div class="letter_3">
		<p>CDM 内のデータベースに対して<strong>コホート定義を評価するため、様々な研究診断を行う</strong>ための R パッケージで、その多くは特定の研究デザインに特化したものではありません。</p>
		<p>参考URL：<a href="https://ohdsi.github.io/CohortDiagnostics/" target="_blank"  rel="nofollow">https://ohdsi.github.io/CohortDiagnostics/</a></p>
	</div>
</div>
<br>
<div class="base_area_3"><strong>Supporting  packages（サポートパッケージ）</strong>
	<div class="headline_1">Cyclops</div>
	<div class="letter_1">
		<p>Cyclops (Cyclic coordinate descent for Logistic、 Poisson and survival analysis) は、<strong>大規模な正則化回帰を行う</strong>ための R パッケージです。</p>
		<p>参考URL：<a href="https://ohdsi.github.io/Cyclops/" target="_blank"  rel="nofollow">https://ohdsi.github.io/Cyclops/</a></p>
	</div>
	<div class="headline_2">DatabaseConnector</div>
	<div class="letter_2">
		<p>この R パッケージは、<strong>様々な DBMS に接続するための機能</strong>を提供します。<br>
		SqlRender パッケージとともに、DatabaseConnector の主な目的は、データベースプラットフォーム間で統一されたインターフェイスを提供することです。</p>
		<p>参考URL：<a href="https://ohdsi.github.io/DatabaseConnector/" target="_blank"  rel="nofollow">https://ohdsi.github.io/DatabaseConnector/</a></p>
	</div>
	<div class="headline_3">SqlRender</div>
	<div class="letter_3">
		<p><strong>パラメータ化された SQL をレンダリングし、異なるSQL言語に変換する</strong>ための R パッケージです。<br>
		SqlRender はスタンドアローンの Java ライブラリやコマンドラインの実行ファイルとしても使用できます。</p>
		<p>参考URL：<a href="https://ohdsi.github.io/SqlRender/" target="_blank"  rel="nofollow">https://ohdsi.github.io/SqlRender/</a></p>
	</div>
	<div class="headline_4">ParallelLogger</div>
	<div class="letter_4">
		<p><strong>プログレスバーを備えた並列計算をサポート</strong>し、エラー時に停止または続行するオプションを備えています。<br>
		また、コンソールやディスクへのロギング機能も備えており、ロギングは並列スレッドでも保持されます。<br>
		追加機能として、遅延実行による関数呼び出しの自動化をサポートしています。（例：関数の並列実行）</p>
		<p>参考URL：<a href="https://ohdsi.github.io/ParallelLogger/" target="_blank"  rel="nofollow">https://ohdsi.github.io/ParallelLogger/</a></p>
	</div>
	<div class="headline_5">FeatureExtraction</div>
	<div class="letter_5">
		<p>OMOP 共通データモデルのデータを用いて、コホートの特徴量（共変量）を生成するための R パッケージです。</p>
		<p>参考URL：<a href="https://ohdsi.github.io/FeatureExtraction/" target="_blank"  rel="nofollow">https://ohdsi.github.io/FeatureExtraction/</a></p>
	</div>
	<div class="headline_6">Andromeda</div>
	<div class="letter_6">
		<p>AsynchroNous Disk-based Representation of MassivE DAta (ANDROMEDA): 大規模なデータオブジェクトを保存するための R パッケージです。<br>
		アンドロメダは、データオブジェクトをローカルドライブに保存しつつ、データを効率的に操作することができます。</p>
		<p>参考URL：<a href="https://ohdsi.github.io/Andromeda/" target="_blank"  rel="nofollow">https://ohdsi.github.io/Andromeda/</a></p>
	</div>
	<div class="headline_7">BigKnn</div>
	<div class="letter_7">
		<p><strong>検索エンジン「Lucene」(<a href="https://lucene.apache.org/" target="_blank"  rel="nofollow">https://lucene.apache.org/</a>)を用いて、大規模な k-nearest neighbor(KNN) 分類器を実装した</strong> R パッケージです。</p>
		<p>参考URL：<a href="https://ohdsi.github.io/Andromeda/" target="_blank"  rel="nofollow">https://ohdsi.github.io/Andromeda/</a></p>
	</div>
	<div class="headline_8">ROhdsiWebApi</div>
	<div class="letter_8">
		<p><strong>WebAPI インスタンスと連携する</strong>ための R パッケージです。</p>
		<p>参考URL：<a href="https://ohdsi.github.io/ROhdsiWebApi/" target="_blank"  rel="nofollow">https://ohdsi.github.io/ROhdsiWebApi/</a></p>
	</div>
	<div class="headline_9">OhdsiSharing</div>
	<div class="letter_9">
		<p><strong>OHDSI パートナー間でデータを共有する</strong>ための R パッケージです。</p>
		<p>参考URL：<a href="https://ohdsi.github.io/OhdsiSharing/" target="_blank"  rel="nofollow">https://ohdsi.github.io/OhdsiSharing/</a></p>
	</div>
	<div class="headline_10">Hydra</div>
	<div class="letter_10">
		<p><strong>JSON 形式の仕様に基づいて、パッケージのスケルトンを実行可能な R スタディパッケージにハイドレートするための R パッケージと Java ライブラリ</strong>です。</p>
		<p>参考URL：<a href="https://ohdsi.github.io/Hydra/" target="_blank"  rel="nofollow">https://ohdsi.github.io/Hydra/</a></p>
	</div>
	<div class="headline_11">Eunomia</div>
	<div class="letter_11">
		<p><strong>OMOP の CDM (共通データモデル)の標準データセットで、テストやデモンストレーションを目的</strong>としています。<br>
			Eunomia は「the Book of OHDSI」 (<a href="https://ohdsi.github.io/TheBookOfOhdsi/" target="_blank"  rel="nofollow">https://ohdsi.github.io/TheBookOfOhdsi/</a>) の多くの演習で使用されています。</p>
			<p>参考URL：<a href="https://ohdsi.github.io/Eunomia/" target="_blank"  rel="nofollow">https://ohdsi.github.io/Eunomia/</a></p>
	</div>
	<div class="headline_12">CirceR</div>
	<div class="letter_12">
		<p><strong>OMOP の CDM (共通データモデル)の標準データセットで、テストやデモンストレーションを目的</strong>としています。<br>
			<strong>OMOP 共通データ・モデルのクエリを作成するためのライブラリである<br>
			「Circe」<a href="https://www.github.com/OHDSI/circe-be" target="_blank"  rel="nofollow">https://www.github.com/OHDSI/circe-be</a> の R ラッパー</strong>です。<br>
			これらのクエリは、コホート定義 (CohortExpression) やカスタム機能 (CriteriaFeature) で使用されます。</p>
			<p>参考URL：<a href="https://ohdsi.github.io/CirceR/" target="_blank"  rel="nofollow">https://ohdsi.github.io/CirceR/</a></p>
			<br>
	</div>
</div>
<br><br><br>
<hr>
<h1 id="cohortmethod-%E4%BD%BF%E7%94%A8%E4%BE%8Bcohortmethod%E3%83%91%E3%83%83%E3%82%B1%E3%83%BC%E3%82%B8%E3%82%92%E7%94%A8%E3%81%84%E3%81%9F%E5%8D%98%E4%B8%80%E7%A0%94%E7%A9%B6"><strong>CohortMethod 使用例（CohortMethod パッケージを用いた単一研究）</strong></h1>
<h1 id="1%E6%9C%AC%E6%9B%B8%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6"><strong>1．本書について</strong></h1>
<p>本書では、CohortMethod パッケージを使用して、単一の新規ユーザーコホート研究を実行する方法について説明します。</p>
<p>ここでは、コキシブと非選択的非ステロイド性抗炎症薬（NSAIDs）の消化管出血による入院への影響という、よく研究されているテーマを選んで、模範的な研究を行うために必要なすべてのステップを説明します。</p>
<p>わかりやすくするために、ここでは1種類のコキシブ（celecoxib）と1種類の非選択的 NSAID（diclofenac）に焦点を当てています。</p>
<br>
<hr>
<h1 id="2%E5%8F%82%E8%80%83%E8%B3%87%E6%96%99"><strong>2．参考資料</strong></h1>
<ul>
<li>CohortMethod パッケージ Web サイト<br>
<a href="https://ohdsi.github.io/CohortMethod/" target="_blank"  rel="nofollow">https://ohdsi.github.io/CohortMethod/</a></li>
<li>CohortMethod パッケージマニュアル<br>
<a href="https://raw.githubusercontent.com/OHDSI/CohortMethod/master/extras/CohortMethod.pdf" target="_blank"  rel="nofollow">https://raw.githubusercontent.com/OHDSI/CohortMethod/master/extras/CohortMethod.pdf</a></li>
<li>Single studies using the CohortMethod package<br>
<a href="https://ohdsi.github.io/CohortMethod/articles/SingleStudies.html" target="_blank"  rel="nofollow">https://ohdsi.github.io/CohortMethod/articles/SingleStudies.html</a></li>
</ul>
<br>
<hr>
<h1 id="3cohortmethod-%E5%87%A6%E7%90%86%E3%81%AE%E6%B5%81%E3%82%8C"><strong>3．CohortMethod 処理の流れ</strong></h1>
<p><img src="./HADES_2/image/image2.png" alt="" width="1200px"></p>
<br>
<hr>
<h1 id="4%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E6%8A%BD%E5%87%BA%E3%83%BB%E8%AA%BF%E6%9F%BB%E5%AF%BE%E8%B1%A1%E3%83%87%E3%83%BC%E3%82%BF%E3%83%A2%E3%83%87%E3%83%AB%E3%81%AE%E4%BD%9C%E6%88%90"><strong>4．データの抽出・調査対象データモデルの作成</strong></h1>
<p>参考 URL：<a href="https://ohdsi.github.io/CohortMethod/articles/SingleStudies.html#data-extraction-1" target="_blank"  rel="nofollow">https://ohdsi.github.io/CohortMethod/articles/SingleStudies.html#data-extraction-1</a></p>
<p>OMOP 共通データモデルから必要なすべてのデータを抽出します。</p>
<p>※ボックス内の記述について</p>
<ul>
<li>□内は、R コンソールでのコマンド入力を表します。</li>
<li>#が付いている行はコメント・解説のため、入力の必要はありません。</li>
<li><strong><span style="color:red;">[ ]</span></strong>内は、環境に合わせて変更します。</li>
</ul>
<br>
<hr>
<h2 id="%E3%82%B5%E3%83%BC%E3%83%90%E3%83%BC%E3%81%B8%E3%81%AE%E6%8E%A5%E7%B6%9A%E3%81%AE%E6%A7%8B%E6%88%90"><strong>サーバーへの接続の構成</strong></h2>
<p>データがあるサーバに接続する方法設定します。<br>
CohortMethod は DatabaseConnector パッケージを使用し、createConnectionDetails 関数を提供しています。<br>
さまざまなデータベース管理システム(DBMS)に必要な特定の設定については、R コンソール上で「??createConnectionDetails」と入力します。<br>
<br>
例えば、次のコードを使用して PostgreSQL データベースに接続することができます。</p>
<pre class="hljs"><code><div>setwd('<strong><span style="color: red; ">[ワークフォルダ]</span></strong>')

library(CohortMethod)

Sys.setenv(&quot;DATABASECONNECTOR_JAR_FOLDER&quot;=&quot;C:\\tomcat\\webapps\\WebAPI\\WEB-INF\\lib&quot;)
connectionDetails &lt;- createConnectionDetails(dbms=&quot;<strong><span style="color: red; ">postgresql</span></strong>&quot;,
    server=&quot;<strong><span style="color: red; ">[コンピュータ名・IPアドレス]/[スキーマ名]</span></strong>&quot;,
    user=&quot;<strong><span style="color: red; ">[接続ユーザー]</span></strong>&quot;,
    password=&quot;<strong><span style="color: red; ">[接続パスワード]</span></strong>&quot;
)

cdmDatabaseSchema &lt;- &quot;<strong><span style="color: red; ">[データベーススキーマ名]</span></strong>&quot;
resultsDatabaseSchema &lt;- &quot;<strong><span style="color: red; ">[抽出結果出力先データベーススキーマ名]</span></strong>&quot; 
options(sqlRenderTempEmulationSchema = NULL)
</div></code></pre>
<p>最後の2行では、cdmDatabaseSchema と resultSchema 変数を定義しています。<br>
これらは後で R に CDM 形式のデータがどこにあるか、どこに中間テーブルを書きたいかを伝えるために使います。<br>
Microsoft SQL Server の場合、データベーススキーマはデータベースとスキーマの両方を指定する必要があることに注意してください。</p>
<br>
<hr>
<h2 id="%E6%9A%B4%E9%9C%B2%E3%81%A8%E7%B5%90%E6%9E%9C%E8%A4%87%E6%95%B0%E3%81%AE%E6%BA%96%E5%82%99"><strong>暴露と結果(複数)の準備</strong></h2>
<p>この研究では、曝露と転帰を定義する必要があります。<br>
外部のコホート定義ツールを使用することもできますが、この例では、OMOP CDM に対して SQL ステートメントを記述して、関心のあるイベントのテーブルを生成します。<br>
結果として得られるテーブルは、CDM のコホートテーブルと同じ構造でなければなりません。<br>
つまり、cohort_deﬁnition_id、cohort_start_date、cohort_end_date、subject_id の各フィールドを持つことになります。</p>
<p>今回の例では、coxibVsNonselVsGiBleed.sql というファイルを作成し、以下の内容としました。<br>
<span style="color: red; ">※ファイルの文字コードは UTF-8 で保存してください。</span></p>
<pre class="hljs"><code><div style="position:relative;">
/***********************************
File coxibVsNonselVsGiBleed.sql
***********************************/
IF OBJECT_ID('@resultsDatabaseSchema.coxibVsNonselVsGiBleed', 'U') IS NOT NULL
DROP TABLE @resultsDatabaseSchema.coxibVsNonselVsGiBleed;

CREATE TABLE @resultsDatabaseSchema.coxibVsNonselVsGiBleed (
	cohort_definition_id INT,
	cohort_start_date DATE,
	cohort_end_date DATE,
	subject_id BIGINT
);

INSERT INTO @resultsDatabaseSchema.coxibVsNonselVsGiBleed (
	cohort_definition_id,
	cohort_start_date,
	cohort_end_date,
	subject_id
)

SELECT 1, -- Exposure
	drug_era_start_date,
	drug_era_end_date,
	person_id
FROM @cdmDatabaseSchema.drug_era
WHERE drug_concept_id = 1118084;-- celecoxib

INSERT INTO @resultsDatabaseSchema.coxibVsNonselVsGiBleed (
	cohort_definition_id,
	cohort_start_date,
	cohort_end_date,
	subject_id
)

SELECT 2, -- Comparator
	drug_era_start_date,
	drug_era_end_date,
	person_id
FROM @cdmDatabaseSchema.drug_era
WHERE drug_concept_id = 1124300; --diclofenac

INSERT INTO @resultsDatabaseSchema.coxibVsNonselVsGiBleed (
	cohort_definition_id,
	cohort_start_date,
	cohort_end_date,
	subject_id
)

SELECT 3, -- Outcome
	condition_start_date,
	condition_end_date,
	condition_occurrence.person_id
FROM @cdmDatabaseSchema.condition_occurrence
INNER JOIN @cdmDatabaseSchema.visit_occurrence
	ON condition_occurrence.visit_occurrence_id = visit_occurrence.visit_occurrence_id
WHERE condition_concept_id IN (
	SELECT descendant_concept_id
	FROM @cdmDatabaseSchema.concept_ancestor
	WHERE ancestor_concept_id = 192671 -- GI - Gastrointestinal hemorrhage
)
AND visit_occurrence.visit_concept_id IN (9201, 9203);
<div style="position:absolute; top:390px; left:210px"><div class="balloon">曝露</div></div><div style="position:absolute; top:480px; left:420px"><div class="balloon">セレコキシブ</div></div><div style="position:absolute; top:655px; left:230px"><div class="balloon">対照群</div></div><div style="position:absolute; top:750px; left:425px"><div class="balloon">ジクロフェナク</div></div><div style="position:absolute; top:920px; left:210px"><div class="balloon">結果</div></div><div style="position:absolute; top:1110px; left:650px"><div class="balloon">消化管出血<br>(gastrointestinal hemorrhage)</div></div>
</div></code></pre>
<p>上記は、SqlRender パッケージで使用できるパラメータ化された SQL です。（@resultsDatabaseSchema、@cdmDatabaseSchema）<br>
パラメータ化した SQL を使用することで、CDM スキーマと結果スキーマの名前を事前に指定する必要がありません。<br>
これにより、異なるスキーマ上で SQL を実行したい場合には、パラメータ値を変更するだけで、SQL コードまで変更する必要がなくなります。<br>
また、SqlRender パッケージの翻訳機能を利用することで、PostgreSQL 以外にも、さまざまなデータベース環境で SQL コードを実行できるようになります。</p>
<br>
<p>作成した SQL ファイルを実行します。<br>
SqlRender パッケージで2つのパラメータを実際の値に置き換え、connectionDetails で指定したデータベースに対して SQL を送信します。</p>
<pre class="hljs"><code><div>library(SqlRender)
sql &lt;- readSql(&quot;coxibVsNonselVsGiBleed.sql&quot;)
sql &lt;- render(sql,
	cdmDatabaseSchema = cdmDatabaseSchema,
	resultsDatabaseSchema = resultsDatabaseSchema)
sql &lt;- translate(sql, targetDialect = connectionDetails$dbms)
</div></code></pre>
<br>
<p>実行結果を確認します。<br>
以下の SQL を実行し、問題がなければ対象となるイベントがテーブルに表示され、タイプごとのイベントの数がわかります。</p>
<pre class="hljs"><code><div>connection &lt;- connect(connectionDetails)
executeSql(connection, sql)
sql &lt;- paste(&quot;SELECT cohort_definition_id, COUNT(*) AS count&quot;,
	&quot;FROM @resultsDatabaseSchema.coxibVsNonselVsGiBleed&quot;,
	&quot;GROUP BY cohort_definition_id&quot;)
sql &lt;- render(sql, resultsDatabaseSchema = resultsDatabaseSchema)
sql &lt;- translate(sql, targetDialect = connectionDetails$dbms)
querySql(connection, sql)
</div></code></pre>
<p>⇩≪結果≫</p>
<pre class="hljs"><code><div>##      cohort_concept_id   count
## 1						1		50000
## 2						2		50000
## 3						3		15000
</div></code></pre>
<br>
<hr>
<h2 id="%E3%82%B5%E3%83%BC%E3%83%90%E3%81%8B%E3%82%89%E3%81%AE%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E6%8A%BD%E5%87%BA"><strong>サーバからのデータの抽出</strong></h2>
<p>CohortMethod にイベントに基づいてコホートを定義し、共変量を構築し、分析に必要なすべてのデータを抽出するように指示することができます。</p>
<br>
<p>重要：標的薬剤と比較対象薬剤は、子孫概念を含めて共変量に含まれていてはいけません。<br>
共変量設定の excludedCovariateConceptIds に薬剤とその子孫を手動で追加する必要があります。<br>
下記の例では、NSAID クラスのコンセプト ID を指定し、addDescendantsToExclude = TRUE を指定することで、すべての NSAID を共変量から除外しています。</p>
<pre class="hljs"><code><div>nsaids &lt;- 21603933
cdmVersion &lt;- 5

<span style="color: green; "># 共変量設定を作成します</span>
covSettings &lt;- createDefaultCovariateSettings(excludedCovariateConceptIds = nsaids,
						addDescendantsToExclude = TRUE)

<span style="color: green; ">#データを抽出します。</span>
cohortMethodData &lt;- getDbCohortMethodData(connectionDetails = connectionDetails,
						cdmDatabaseSchema = cdmDatabaseSchema,
						targetId = 1,
						comparatorId = 2,
						outcomeIds = 3,
						studyStartDate = &quot;&quot;,
						studyEndDate = &quot;&quot;,
						exposureDatabaseSchema = resultsDatabaseSchema,
						exposureTable = &quot;coxibVsNonselVsGiBleed&quot;,
						outcomeDatabaseSchema = resultsDatabaseSchema,
						outcomeTable = &quot;coxibVsNonselVsGiBleed&quot;,
						cdmVersion = cdmVersion,
						firstExposureOnly = TRUE,
						removeDuplicateSubjects = TRUE,
						restrictToCommonPeriod = FALSE,
						washoutPeriod = 180,
						covariateSettings = covSettings)
</div></code></pre>
<br>
<p>抽出したデータの表示</p>
<pre class="hljs"><code><div>cohortMethodData
</div></code></pre>
<p>⇩≪結果≫</p>
<pre class="hljs"><code><div>## # CohortMethodData object
##
## Target cohort ID: 1
## Comparator cohort ID: 2
## Outcome cohort ID(s): 3
##
## Inherits from CovariateData:
## # CovariateData object
##
## All cohorts
##
## Inherits from Andromeda:
## # Andromeda object
## # Physical location: C:\Users\mschuemi\AppData\Local\Temp\RtmponKEpH\file2864201706.sqlite
##
## Tables:
## $analysisRef (analysisId, analysisName, domainId, startDay, endDay, isBinary, missingMeansZero)
## $cohorts (rowId, personSeqId, personId, treatment, cohortStartDate, daysFromObsStart, daysToCohortEnd, daysToObsEnd)
## $covariateRef (covariateId, covariateName, analysisId, conceptId)
## $covariates (rowId, covariateId, covariateValue)
## $outcomes (rowId, outcomeId, daysToEvent)
</div></code></pre>
<br>
<p>多くのパラメータがありますが、それらはすべて CohortMethod のマニュアルに記載されています。<br>
createDefaultCovariateSettings 関数は、FeatureExtraction パッケージのマニュアルに記載されています。<br>
この関数に先ほど作成したテーブルを指定し、そのテーブル内のどの概念 ID がターゲット、コンパレータ、アウトカムを特定しているかを示しています。<br>
指標日以前に発見されたすべての条件、薬物曝露、処置に関する共変量を含む、デフォルトの共変量セットを構築するように指示する。<br>
共変量のセットをカスタマイズするには、vignette(&quot;UsingFeatureExtraction&quot;, package=&quot;FeatureExtraction&quot;) と入力して、FeatureExtraction パッケージのヴィネットを参照してください。</p>
<br>
<p>コホート、アウトカム、共変量に関するすべてのデータは、サーバーから抽出され、cohortMethodData オブジェクトに格納されます。<br>
このオブジェクトは Andromeda パッケージを使用して、データが大きくても R がメモリ不足にならないような方法で情報を保存します。<br>
summary() 関数を使って、抽出したデータの詳細情報を見ることができます。</p>
<pre class="hljs"><code><div>summary(cohortMethodData)
</div></code></pre>
<p>⇩≪結果≫</p>
<pre class="hljs"><code><div>## CohortMethodData object summary
##
## Target cohort ID: 1
## Comparator cohort ID: 2
## Outcome cohort ID(s): 3
##
## Target persons: 50000
## Comparator persons: 50000
##
## Outcome counts:
## Event count Person count
## 3 13474 7009
##
## Covariates:
## Number of covariates: 64377
## Number of non-zero covariate values: 43920369
</div></code></pre>
<br><br><br>
<hr>
<h2 id="%E6%96%B0%E8%A6%8F%E4%BD%BF%E7%94%A8%E8%80%85%E3%81%AE%E5%AE%9A%E7%BE%A9"><strong>新規使用者の定義</strong></h2>
<p>新規使用者は、薬剤（標的または比較対象のいずれか）を初めて使用した場合と定義され、一般的には、本当に初めての使用であることを確認するためにウォッシュアウト期間（初回使用前の最低日数）が使用されます。<br>
CohortMethod パッケージを使用する場合、3つのオプションで新規使用に必要な要件を実施することができます。</p>
<ol>
<li>コホート定義ツールなどを使用して、データベース内にコホートを作成するとき。</li>
<li>上記の例のように、getDbCohortMethodData 関数を使用してコホートを読み込む際に、firstExposureOnly、removeDuplicateSubjects、restrictToCommonPeriod、washoutPeriod の各引数を使用することができます。</li>
<li>firstExposureOnly、removeDuplicateSubjects、restrictToCommonPeriod、washoutPeriod の各引数を用いて、createStudyPopulation 関数（後述）を用いて研究集団を定義する場合。</li>
</ol>
<p>オプション1の利点は、入力コホートが CohortMethod パッケージの外で既に完全に定義されており、例えば、外部のコホート特性評価ツールをこのパッケージで使用されているのと同じコホートに使用できることです。<br>
オプション2と3の利点は、例えば CDM の drug_era テーブルを直接使用できるようにするなど、自分で初回使用に限定する手間が省けることです。<br>
オプション2は、初回使用のデータのみが取得されるため、オプション3よりも効率的ですが、オプション3は効率的ではありませんが、元のコホートと研究対象集団を比較することができます。</p>
<br><br><br>
<hr>
<h1 id="5%E8%AA%BF%E6%9F%BB%E5%AF%BE%E8%B1%A1%E9%9B%86%E5%9B%A3%E3%81%AE%E5%AE%9A%E7%BE%A9"><strong>5．調査対象集団の定義</strong></h1>
<p>参考URL：<a href="https://ohdsi.github.io/CohortMethod/articles/SingleStudies.html#defining-the-study-population-1" target="_blank"  rel="nofollow">https://ohdsi.github.io/CohortMethod/articles/SingleStudies.html#defining-the-study-population-1</a></p>
<br>
<p>通常、曝露コホートと転帰コホートは、それぞれ独立して定義されます。<br>
効果量の推定値を算出したい場合は、これらのコホートをさらに制限してまとめる必要があります。<br>
例えば、曝露前に転帰を有していた曝露対象者を除外し、定義されたリスクウィンドウ内にある転帰のみを保持します。<br>
そのためには、createStudyPopulation 関数を使用します。</p>
<pre class="hljs"><code><div><span style="color: green; "># 調査対象母集団を作成します。</span>
studyPop &lt;- createStudyPopulation(cohortMethodData = cohortMethodData,
						outcomeId = 3,
						firstExposureOnly = FALSE,
						restrictToCommonPeriod = FALSE,
						washoutPeriod = 0,
						removeDuplicateSubjects = &quot;keep all&quot;,
						removeSubjectsWithPriorOutcome = TRUE,
						minDaysAtRisk = 1,
						riskWindowStart = 0,
						startAnchor = &quot;cohort start&quot;,
						riskWindowEnd = 30,
						endAnchor = &quot;cohort end&quot;)
</div></code></pre>
<br>
<p>ここでは、firstExposureOnly と removeDuplicateSubjects を FALSE に設定し、washoutPeriod を0に設定していることに注意してください。<br>
これは、getDbCohortMethodData 関数を使用する際に、これらの引数ですでにフィルタリングしているからです。<br>
読み込み時に restrictToCommonPeriod を FALSE に設定しましたが、両方の薬剤が記録された時間のみに比較を強制したくないので、ここでも同様に設定します。<br>
使用するアウトカム ID を指定し、リスクウィンドウの開始日より前のアウトカムを持つ人々を削除します。<br>
リスクウィンドウは、コホート開始日（指標日、riskWindowStart = 0 and startAnchor = &quot;cohort start&quot;）から始まり、リスクウィンドウはコホート終了から30日後に終了すると定義されます。（riskWindowEnd = 30 and endAnchor = &quot;cohort end&quot;）<br>
なお，リスクウィンドウは観察終了日または研究終了日で切り捨てられます。<br>
また、リスクのある時間がない被験者も削除します。</p>
<br>
<p>調査対象者に何人の人が残っているかを見るには、getAttritionTable 関数を使うことができます。</p>
<pre class="hljs"><code><div><span style="color: green; "># 母集団の減少表を取得します。</span>
getAttritionTable(studyPop)
</div></code></pre>
<p>⇩≪結果≫</p>
<pre class="hljs"><code><div>## # A tibble: 5 x 5
## description										targetPersons	comparatorPersons	targetExposures		comparatorExposures
## 	&lt;chr&gt;											&lt;dbl&gt;				&lt;dbl&gt;						&lt;dbl&gt;					&lt;dbl&gt;
## 1 Original cohorts								150109				814723						263358					1395611
## 2 First exp. only &amp; removed s ... 		69006				582090						69006					582090
## 3 Random sample							50000 				50000						50000					50000
## 4 No prior outcome							48088				48394						48088					48394
## 5 Have at least 1 days at ris ...			48041				48337						48041					48337
</div></code></pre>
<br>
<p>よく使われる追加のフィルタリング手順としては、傾向モデルのマッチングやトリミングがあります。</p>
<br><br><br>
<hr>
<h1 id="6%E5%82%BE%E5%90%91%E3%82%B9%E3%82%B3%E3%82%A2%E5%88%86%E6%9E%90"><strong>6．傾向スコア分析</strong></h1>
<p>参考URL：<a href="https://ohdsi.github.io/CohortMethod/articles/SingleStudies.html#propensity-scores-1" target="_blank"  rel="nofollow">https://ohdsi.github.io/CohortMethod/articles/SingleStudies.html#propensity-scores-1</a></p>
<br>
<p>CohortMethod では、潜在的な交絡因子を調整するために傾向スコアを使用することができます。<br>
CohortMethod では、一握りの定義済み共変量を使用する従来の方法ではなく、被験者の記録にある条件、手順、薬剤に基づいて自動的に構築された数千から数百万の共変量を使用するのが一般的です。</p>
<br>
<hr>
<h2 id="%E5%82%BE%E5%90%91%E3%83%A2%E3%83%87%E3%83%AB%E3%81%AE%E3%83%95%E3%82%A3%E3%83%83%E3%83%86%E3%82%A3%E3%83%B3%E3%82%B0"><strong>傾向モデルのフィッティング</strong></h2>
<p>getDbcohortMethodData() 関数によって構築された共変量を使用して、傾向モデルを適合させることができます。<br>
createPs() 関数は、Cyclops パッケージを使用して、大規模な正則化ロジスティック回帰を適合させます。</p>
<pre class="hljs"><code><div><span style="color: green; "># 正則化されたロジスティック回帰を使用して傾向スコアを作成します。</span>
ps &lt;- createPs(cohortMethodData = cohortMethodData, population = studyPop)
</div></code></pre>
<br>
<p>傾向モデルをフィットさせるために、Cyclops には事前の分散を指定するハイパーパラメータの値を設定する必要があります。<br>
デフォルトでは、Cyclops はクロスバリデーションを用いて最適なハイパーパラメータを推定します。<br>
しかし、これには非常に⾧い時間がかかることに注意してください。<br>
createPs() の事前パラメータとコントロールパラメータを使って、クロスバリデーションを高速化するために複数の CPU を使うなど、Cyclops の動作を指定することができます。</p>
<br><br>
<hr>
<h2 id="%E5%82%BE%E5%90%91%E3%82%B9%E3%82%B3%E3%82%A2%E8%A8%BA%E6%96%AD%E3%82%92%E8%A1%8C%E3%81%86"><strong>傾向スコア診断を行う</strong></h2>
<p>傾向スコアモデルの受信者操作曲線下の面積（AUC）を計算することができます。</p>
<pre class="hljs"><code><div><span style="color: green; "># 傾向スコアのROC曲線下面積を計算します。</span>
computePsAuc(ps)
</div></code></pre>
<p>⇩≪結果≫</p>
<pre class="hljs"><code><div>## [1] 0.81
</div></code></pre>
<br>
<p>傾向スコア分布をプロットすることもできますが、ここでは選好スコア分布を使用します。</p>
<pre class="hljs"><code><div><span style="color: green; "># 傾向スコア（またはプリファレンス）の分布をプロットします。</span>
plotPs(ps,
	scale = &quot;preference&quot;,
	showCountsLabel = TRUE,
	showAucLabel = TRUE,
	showEquiposeLabel = TRUE)
</div></code></pre>
<br>
<p>上記を実行すると、R コンソール上に以下のようなグラフが描画されます。</p>
<p><img src=".\HADES_2/image/image3.png" alt="" width="800px"></p>
<br>
<p>※ R コンソール上で画面を切り替える場合は、「コンソールに戻る」ボタンまたは「ウィンドウ」メニューを使用します。<br>
<img src=".\HADES_2/image/image4.png" alt="" width="1100px"></p>
<br>
<p>係数がゼロ以外の共変量を表示することにより、傾向モデル自体を検査することもできます。</p>
<pre class="hljs"><code><div><span style="color: green; ">#  傾向モデルを取得します。係数がゼロではない共変量の係数と名前を返します。</span>
getPsModel(ps, cohortMethodData)
</div></code></pre>
<p>⇩≪結果≫</p>
<pre class="hljs"><code><div>## # A tibble: 6 x 3
## 		coefficient covariateId covariateName
##		&lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;
## 1  	-1.75	21602430413 ...gh 0 days relative to index: UTEROTONICS
## 2  	1.48		2007006 index year: 2007
## 3  	1.25		4253901210 ... to index: Juvenile rheumatoid arthritis
## 4  	-1.15	44967547602 ...ative to index: LIPOPEN ULTRA CREAM BASE
## 5  	1.15		2008006 index year: 2008
## 6  	-1.08	3003 age group: 15 - 19
</div></code></pre>
<br>
<p>傾向モデルを当てはめる際に正則化を使用する利点の1つは、ほとんどの係数がゼロに縮小し、モデルから脱落することです。<br>
残りの変数を調べて、そこにあるべきではないものがないかどうかを調べることをお勧めします。<br>
たとえば、除外するのを忘れた対象薬物のバリエーションなどです。</p>
<br><br>
<hr>
<h2 id="%E5%82%BE%E5%90%91%E3%82%B9%E3%82%B3%E3%82%A2%E3%81%AE%E4%BD%BF%E7%94%A8"><strong>傾向スコアの使用</strong></h2>
<p>傾向スコアを使って、母集団をトリミング、層別、マッチ、または計量することができます。<br>
例えば、preference  score が0.25から0.75の間の被験者のみを残して、equipoise にトリミングすることができます。</p>
<pre class="hljs"><code><div><span style="color: green; ">#  プリファレンススコアを利用して、臨床的に平衡状態にない被験者をトリミングします。</span>
trimmedPop &lt;- trimByPsToEquipoise(ps)
<span style="color: green; ">#  傾向スコア（またはプリファレンス）の分布をプロットします。</span>
plotPs(trimmedPop, ps, scale = &quot;preference&quot;)
</div></code></pre>
<br>
<p>上記を実行すると、R コンソール上に以下のようなグラフが描画されます。<br>
<img src=".\HADES_2/image/image5.jpg" alt="" width="800px"></p>
<br>
<p>代わりに（あるいは追加で）、傾向スコアに基づいて母集団を層別化することもできます。</p>
<pre class="hljs"><code><div><span style="color: green; ">#  提供された傾向スコアを使用して、人を層別します。追加の層別変数を使用することもできます。</span>
stratifiedPop &lt;- stratifyByPs(ps, numberOfStrata = 5)

<span style="color: green; ">#  傾向スコア（またはプリファレンス）の分布をプロットします。</span>
plotPs(stratifiedPop, ps, scale = &quot;preference&quot;)
</div></code></pre>
<br>
<p>上記を実行すると、R コンソール上に以下のようなグラフが描画されます。
<img src=".\HADES_2/image/image6.jpg" alt="" width="800px"></p>
<br>
<p>傾向スコアに基づいて被験者をマッチングすることもできます。<br>
この例では、1対1のマッチングを使用しています。</p>
<pre class="hljs"><code><div><span style="color: green; ">#  提供された傾向スコアを使用して、対象者と比較対象者を照合します。</span>
matchedPop &lt;- matchOnPs(ps, caliper = 0.2, caliperScale = &quot;standardized logit&quot;, maxRatio = 1)

<span style="color: green; ">#  傾向スコア（またはプリファレンス）の分布をプロットします。</span>
plotPs(matchedPop, ps)
</div></code></pre>
<br>
<p>上記を実行すると、R コンソール上に以下のようなグラフが描画されます。
<img src=".\HADES_2/image/image7.jpg" alt="" width="800px"></p>
<br>
<p>なお、層化とマッチングの両方において、年齢や性別などの追加のマッチング基準を、それぞれ stratifyByPsAndCovariates() 関数と matchOnPsAndCovariates() 関数を使って指定することができます。</p>
<p>トリミングやマッチングの母集団への影響は、getAttritionTable 関数を使って見ることができます。</p>
<pre class="hljs"><code><div><span style="color: green; "># 母集団の減少表を取得します。</span>
getAttritionTable(matchedPop)
</div></code></pre>
<p>⇩≪結果≫</p>
<pre class="hljs"><code><div>## # A tibble: 6 x 5				
## 	description								targetPersons	comparatorPersons	targetExposures		comparatorExposures
## 	&lt;chr&gt;										&lt;dbl&gt;				&lt;dbl&gt;						&lt;dbl&gt;					&lt;dbl&gt;
## 1 Original cohorts							150109				814723						263358					1395611
## 2 First exp. only &amp; removed s ...	69006				582090						69006					582090
## 3 Random sample						50000				50000						50000					50000
## 4 No prior outcome						48088				48394						48088					48394
## 5 Have at least 1 days at ris ...		48041				48337						48041					48337
## 6 Matched on propensity score		24609				24609						24609					4609
</div></code></pre>
<br>
<p>また、人員摩耗図を描くこともできます。</p>
<pre class="hljs"><code><div><span style="color: green; ">#  何人がどのような理由で調査対象から除外されたかを示す摩耗図を描画します。</span>
drawAttritionDiagram(matchedPop)
</div></code></pre>
<br>
<p>上記を実行すると、R コンソール上に以下のような図が描画されます。</p>
<img src=".\HADES_2/image/image8.jpg" alt="">
<br><br><br><br><br>
<hr>
<h2 id="7%E5%85%B1%E5%A4%89%E9%87%8F%E3%83%90%E3%83%A9%E3%83%B3%E3%82%B9%E3%81%AE%E8%A9%95%E4%BE%A1"><strong>7．共変量バランスの評価</strong></h2>
<p>参考URL：<a href="https://ohdsi.github.io/CohortMethod/articles/SingleStudies.html#evaluating-covariate-balance-1" target="_blank"  rel="nofollow">https://ohdsi.github.io/CohortMethod/articles/SingleStudies.html#evaluating-covariate-balance-1</a></p>
<p>傾向スコアの使用が実際に2つのコホートをより比較可能にしているかどうかを評価するために、トリミング、マッチング、層別化の前と後の共変量バランスを計算することができます。</p>
<pre class="hljs"><code><div><span style="color: green; ">#  すべての共変量について、マッチング／トリミングの前後で、治療群と比較群の有病率を計算します。</span>
balance &lt;- computeCovariateBalance(matchedPop, cohortMethodData)

<span style="color: green; ">#  共変量バランスの散布図を作成し、マッチング前後のすべての変数をx軸とy軸にそれぞれ表示します。</span>
plotCovariateBalanceScatterPlot(balance, showCovariateCountLabel = TRUE, showMaxLabel = TRUE)
</div></code></pre>
<p>上記を実行すると、R コンソール上に以下のようなグラフが描画されます。</p>
<img src=".\HADES_2/image/image9.png" alt="" width="800px">
<br>
<pre class="hljs"><code><div><span style="color: green; ">#  マッチング前に最大の不均衡を持つ変数と、マッチング後に最大の不均衡を持つ変数を示すプロットを作成します。</span>
plotCovariateBalanceOfTopVariables(balance)
</div></code></pre>
<p>上記を実行すると、R コンソール上に以下のような図が描画されます。</p>
<img src=".\HADES_2/image/image10.jpg" alt="" width="1000px">
<p>「マッチング前」の母集団とは、getDbCohortMethodData 関数によって抽出された母集団であり、これはさらなるフィルタリングステップの前のものです。</p>
<br>
<hr>
<h2 id="%E7%89%B9%E5%AE%9A%E3%81%AE%E6%AF%8D%E9%9B%86%E5%9B%A3%E3%81%AE%E7%89%B9%E5%BE%B4%E3%82%92%E8%AA%BF%E3%81%B9%E3%82%8B"><strong>特定の母集団の特徴を調べる</strong></h2>
<p>論文には、マッチング/層別化/トリミングの前後で、いくつかの厳選された母集団の特徴を示す表を掲載するのが通例です。<br>
これは通常、最初の表であり、「Table 1」と呼ばれます。<br>
この表を作成するには、createCmTable1 関数を使用することができます。</p>
<pre class="hljs"><code><div><span style="color: green; ">#  出版物や報告書に掲載するための、コホートの特徴をまとめた表を作成します。  </span>
createCmTable1(balance)  
</div></code></pre>
<p>⇩≪結果≫
<img src=".\HADES_2/image/image11.png" alt="" width="1200px"></p>
<br><br><br>
<hr>
<h2 id="%E3%83%87%E3%83%BC%E3%82%BF%E3%83%99%E3%83%BC%E3%82%B9%E3%81%B8%E3%81%AE%E9%9B%86%E5%9B%A3%E3%82%B3%E3%83%9B%E3%83%BC%E3%83%88%E3%81%AE%E6%8C%BF%E5%85%A5"><strong>データベースへの集団コホートの挿入</strong></h2>
<p>外部のコホート特性評価ツールを使用する場合など、さまざまな理由で研究集団をデータベースに再挿入する必要があるかもしれません。<br>
この目的のために、insertDbPopulation 関数を使用できます。</p>
<pre class="hljs"><code><div><span style="color: green; "># 母集団をデータベースに挿入します。</span>
insertDbPopulation(population = matchedPop,
        cohortIds = c(101,100),
        connectionDetails = connectionDetails,
        cohortDatabaseSchema = resultsDatabaseSchema, cohortTable = &quot;coxibVsNonselVsGiBleed&quot;,
        createTable = FALSE,
        cdmVersion = cdmVersion)
</div></code></pre>
<p>この関数は、CDM のコホートテーブルと同じ構造のテーブルに母集団を保存します。<br>
ここでは、元のコホートを作成したのと同じテーブルに保存します。</p>
<br>
<hr>
<h1 id="8%E3%83%95%E3%82%A9%E3%83%AD%E3%83%BC%E3%82%A2%E3%83%83%E3%83%97%E3%81%A8%E6%A4%9C%E5%87%BA%E5%8A%9B"><strong>8．フォローアップと検出力</strong></h1>
<p>参考URL：<a href="https://ohdsi.github.io/CohortMethod/articles/SingleStudies.html#follow-up-and-power-1" target="_blank"  rel="nofollow">https://ohdsi.github.io/CohortMethod/articles/SingleStudies.html#follow-up-and-power-1</a></p>
<br>
<p>結果モデルの適合を開始する前に、特定の効果サイズを検出するのに十分な検出力があるかどうかを知りたいと思うかもしれません。<br>
研究集団が完全に定義された後にこれらの検出力の計算を行うことは理にかなっており、様々な包含および除外基準（過去の結果がないなど）による損失、マッチングおよび(または)トリミングによる損失を考慮に入れます。<br>
レトロスペクティブ研究ではサンプルサイズが固定されており（データはすでに収集されている）、真の効果サイズは不明であるため、 CohortMethod パッケージは代わりに最小検出可能相対リスク（MDRR）を計算する関数を提供しています。</p>
<pre class="hljs"><code><div><span style="color: green; ">#  研究母集団に対する最小検出可能相対リスク（MDRR）と期待される標準誤差（SE）を計算します。</span>
computeMdrr(population = studyPop,
        modelType = &quot;cox&quot;,
        alpha = 0.05,
        power = 0.8,
        twoSided = TRUE)
</div></code></pre>
<p>⇩≪結果≫
<img src=".\HADES_2/image/image12.png" alt="" width="1200px"></p>
<br>
<p>この例では、studyPop オブジェクトを使用したので、マッチングやトリミングを行う前の母集団です。<br>
マッチング後のMDRRを知りたい場合は、先に作成した matchedPop オブジェクトを代わりに使用します。</p>
<pre class="hljs"><code><div>computeMdrr(population = matchedPop,
        modelType = &quot;cox&quot;,
        alpha = 0.05,
        power = 0.8,
        twoSided = TRUE)
</div></code></pre>
<p>⇩≪結果≫
<img src=".\HADES_2/image/image13.png" alt="" width="1200px"></p>
<br>
<p>一致させた集団の MDRR が高く、検出力が低いとはいえ、騙されてはいけません。<br>
一致させることで交絡が排除される可能性が高いため、一致させないよりも好ましいと言えます。</p>
<br>
<p>利用可能な追跡調査の量をよりよく理解するために、追跡調査の時間の分布を調べることもできます。<br>
フォローアップ時間をリスクのある時間と定義したので、アウトカムの発生によって打ち切られることはありません。<br>
getFollowUpDistribution で簡単に概要を知ることができます。</p>
<pre class="hljs"><code><div><span style="color: green; ">#  フォローアップ時間の分布を分位数として取得します。</span>
getFollowUpDistribution(population = matchedPop)
</div></code></pre>
<p>⇩≪結果≫
<img src=".\HADES_2/image/image14.png" alt="" width="1200px"></p>
<br>
<p>出力結果は、調査母集団の各分位が何日フォローアップを受けたかを示しています。<br>
また、分布をプロットすることもできます。</p>
<pre class="hljs"><code><div><span style="color: green; ">#  治療群ごとに層別化されたフォローアップ時間の分布をプロットします。</span>
plotFollowUpDistribution(population = matchedPop)
</div></code></pre>
<br>
<p>上記を実行すると、R コンソール上に以下のようなグラフが描画されます。
<img src=".\HADES_2/image/image15.png" alt="" width="800px"></p>
<br><br><br>
<hr>
<h1 id="9%E3%82%A2%E3%82%A6%E3%83%88%E3%82%AB%E3%83%A0%E3%83%A2%E3%83%87%E3%83%AB"><strong>9．アウトカムモデル</strong></h1>
<p>参考URL：<a href="https://ohdsi.github.io/CohortMethod/articles/SingleStudies.html#outcome-models-1" target="_blank"  rel="nofollow">https://ohdsi.github.io/CohortMethod/articles/SingleStudies.html#outcome-models-1</a></p>
<br>
<p>アウトカムモデルとは、どのような変数がアウトカムと関連するかを記述したモデルのことです。</p>
<br>
<hr>
<h2 id="%E5%8D%98%E7%B4%94%E3%81%AA%E3%82%A2%E3%82%A6%E3%83%88%E3%82%AB%E3%83%A0%E3%83%BB%E3%83%A2%E3%83%87%E3%83%AB%E3%81%AE%E9%81%A9%E5%90%88"><strong>単純なアウトカム・モデルの適合</strong></h2>
<p>理論的には、傾向スコアを使用せずにアウトカム・モデルを当てはめることができます。<br>
この例では、Cox 回帰を使ってアウトカム・モデルを当てはめています。</p>
<pre class="hljs"><code><div><span style="color: green; ">#  アウトカムモデルを作成し、相対リスクを計算します。</span>
outcomeModel &lt;- fitOutcomeModel(population = studyPop,
                  modelType = &quot;cox&quot;)
outcomeModel
</div></code></pre>
<p>⇩≪結果≫</p>
<pre class="hljs"><code><div>## Model type: cox
## Stratified: FALSE
## Use covariates: FALSE
## Use inverse probability of treatment weighting: FALSE
## Status: OK
##
##      Estimate lower .95 upper .95 logRr seLogRr
## treatment 1.012159 0.830005 1.238075 0.012086 0.102
</div></code></pre>
<br>
<p>しかし、もちろん、傾向スコアで行われたマッチングを利用したいと思います。</p>
<pre class="hljs"><code><div><span style="color: green; ">#  アウトカムモデルを作成し、相対リスクを計算します。</span>
outcomeModel &lt;- fitOutcomeModel(population = matchedPop,
                modelType = &quot;cox&quot;,
                stratified = TRUE)
outcomeModel
</div></code></pre>
<p>⇩≪結果≫</p>
<pre class="hljs"><code><div>## Model type: cox
## Stratified: TRUE
## Use covariates: FALSE
## Use inverse probability of treatment weighting: FALSE
## Status: OK
##
##      Estimate lower .95 upper .95 logRr seLogRr
## treatment 0.84130 0.60336 1.16346 -0.17281 0.1675
</div></code></pre>
<br>
<p>ここでは、サブポピュレーションを、先に傾向スコアでマッチングして作成した matchedPop オブジェクトに含まれるものだけと定義していることに注意してください。<br>
また、ここでは層化 Cox モデルを使用し、傾向スコアのマッチセットで条件付けを行います。</p>
<br>
<p>マッチングや層別の代わりに、IPTW（Inverse Probability of Treatment Weighting）を行うこともできます。</p>
<pre class="hljs"><code><div><span style="color: green; ">#  アウトカムモデルを作成し、相対リスクを計算します。</span>
outcomeModel &lt;- fitOutcomeModel(population = ps,
        modelType = &quot;cox&quot;,
        inversePtWeighting = TRUE)
outcomeModel
</div></code></pre>
<p>⇩≪結果≫</p>
<pre class="hljs"><code><div>## Model type: cox
## Stratified: FALSE
## Use covariates: FALSE
## Use inverse probability of treatment weighting: TRUE 
## Status: OK
##
##      Estimate lower .95 upper .95 logRr seLogRr
## treatment 1.012159 0.830005 1.238075 0.012086 0.102
</div></code></pre>
<br><br><br>
<hr>
<h2 id="%E4%BA%A4%E4%BA%92%E4%BD%9C%E7%94%A8%E9%A0%85%E3%81%AE%E8%BF%BD%E5%8A%A0"><strong>交互作用項の追加</strong></h2>
<p>母集団の異なるグループ間で効果が異なるかどうかに興味があるかもしれません。<br>
これを調べるために、モデルに交互作用項を含めることができます。<br>
この例では、3つの交互作用項を加えています。</p>
<pre class="hljs"><code><div><span style="color: green; "># ベクトルを作成します</span>
interactionCovariateIds &lt;- c(8532001, 201826210, 21600960413)
                # 8532001 = Female(女性)
                # 201826210 = Type 2 Diabetes(2型糖尿病)
                # 21600960413 = Concurent use of antithrombotic agents(抗血栓剤の同時使用)

<span style="color: green; ">#  アウトカムモデルを作成し、相対リスクを計算します</span>
outcomeModel &lt;- fitOutcomeModel(population = matchedPop,
        modelType = &quot;cox&quot;,
        stratified = TRUE,
        interactionCovariateIds = interactionCovariateIds)
outcomeModel
</div></code></pre>
<p>⇩≪結果≫
<img src=".\HADES_2/image/image16.png" alt="" width="1200px"></p>
<p>grepCovariateNames を使用して共変量 ID を見つけることができることに注意してください。</p>
<br>
<p>共変量のバランスが目的のサブグループでも達成されているかどうかを確認することが賢明です。<br>
例えば、女性の部分集団における共変量のバランスを確認することができます。</p>
<pre class="hljs"><code><div><span style="color: green; ">#  すべての共変量について、マッチング／トリミングの前後で、治療群と比較群の有病率を計算します。</span>
balanceFemale &lt;- computeCovariateBalance(population = matchedPop,
        cohortMethodData = cohortMethodData,
        subgroupCovariateId = 8532001)
                # 8532001 = Female(女性)

<span style="color: green; ">#  共変量バランスの散布図を作成し、マッチング前後のすべての変数を x 軸と y 軸にそれぞれ表示します。</span>
plotCovariateBalanceScatterPlot(balanceFemale)
</div></code></pre>
<br>
<p>上記を実行すると、R コンソール上に以下のようなグラフが描画されます。
<img src=".\HADES_2/image/image17.png" alt="" width="800px"></p>
<br>
<hr>
<h2 id="%E7%B5%90%E6%9E%9C%E3%83%A2%E3%83%87%E3%83%AB%E3%81%B8%E3%81%AE%E5%85%B1%E5%A4%89%E9%87%8F%E3%81%AE%E8%BF%BD%E5%8A%A0"><strong>結果モデルへの共変量の追加</strong></h2>
<p>最後の改良点は、傾向モデルの適合に使用したのと同じ共変量を結果モデルの適合にも使用することです。<br>
こうすることで、モデルの誤指定に対するロバスト性が高まり、バイアスを除去できる可能性が高くなります。<br>
これには、Cyclops パッケージの正則化 Cox 回帰を使用します。(治療変数は正則化から自動的に除外されることに注意してください)</p>
<pre class="hljs"><code><div><span style="color: green; ">#  アウトカムモデルを作成し、相対リスクを計算します</span>
outcomeModel &lt;- fitOutcomeModel(population = matchedPop,
                cohortMethodData = cohortMethodData,
                modelType = &quot;cox&quot;,
                stratified = TRUE,
                useCovariates = TRUE)
outcomeModel
</div></code></pre>
<p>⇩≪結果≫</p>
<pre class="hljs"><code><div>## Model type: cox
## Stratified: TRUE
## Use covariates: TRUE
## Use inverse probability of treatment weighting: FALSE
## Status: OK
## Prior variance: 0.0548363196687061 
##
##	Estimate lower .95 upper .95 logRr seLogRr
## treatment 0.82652 0.53234 1.26979 -0.19053 0.2218
</div></code></pre>
<br><br><br>
<hr>
<h2 id="%E3%82%A2%E3%82%A6%E3%83%88%E3%82%AB%E3%83%A0%E3%83%A2%E3%83%87%E3%83%AB%E3%81%AE%E6%A4%9C%E8%A8%BC"><strong>アウトカムモデルの検証</strong></h2>
<p>アウトカムモデルの詳細を検査することができます。</p>
<pre class="hljs"><code><div><span style="color: green; "># 回帰係数を抽出します。</span>
exp(coef(outcomeModel))
</div></code></pre>
<p>⇩≪結果≫</p>
<pre class="hljs"><code><div>## 900000010805
## 0.8265208
</div></code></pre>
<br>
<br>
<pre class="hljs"><code><div><span style="color: green; "># 回帰係数の信頼区間を求めます。</span>
exp(confint(outcomeModel))
</div></code></pre>
<p>⇩≪結果≫</p>
<pre class="hljs"><code><div>## [1] 0.5323388 1.2697883
</div></code></pre>
<br>
<p>また、アウトカムモデルに組み込まれた共変量も確認できます。</p>
<pre class="hljs"><code><div><span style="color: green; ">#  アウトカムモデルを取得し、アウトカムモデルに含まれるすべての変数のベータ値を表示します。</span>
getOutcomeModel(outcomeModel, cohortMethodData)
</div></code></pre>
<p>⇩≪結果≫</p>
<pre class="hljs"><code><div>## coefficient id  name
## 1 -0.1905302 9e+11 Treatment
</div></code></pre>
<br>
<hr>
<h2 id="%E3%82%AB%E3%83%97%E3%83%A9%E3%83%B3%E3%83%BB%E3%83%9E%E3%82%A4%E3%83%A4%E3%83%BC%E3%83%97%E3%83%AD%E3%83%83%E3%83%88"><strong>カプラン・マイヤープロット</strong></h2>
<p>カプラン・マイヤープロット(生存率曲線)を作成することができます。</p>
<pre class="hljs"><code><div><span style="color: green; ">#  カプラン・マイヤープロット(生存率曲線)を作成します。</span>
plotKaplanMeier(matchedPop, includeZero = FALSE)
</div></code></pre>
<br>
<p>上記を実行すると、R コンソール上に以下のようなグラフが描画されます。</p>
<p><img src=".\HADES_2/image/image18.png" alt="" width="800px"></p>
<br>
<p>なお、Kaplan-Meier プロットは、適用されている可能性のある層別化、マッチング、またはトリミングを自動的に調整します。</p>
<br><br><br>
<hr>
<h2 id="time-to-event%E3%83%97%E3%83%AD%E3%83%83%E3%83%88"><strong>Time-to-event プロット</strong></h2>
<p>Time-to-event プロット(生存時間解析)では、指標日の前後のイベントや、定義された time-at-risk window の中と外のイベントを表示することができます。<br>
このプロットは、暴露に関連した転帰の時間的パターンを知ることができます。</p>
<pre class="hljs"><code><div><span style="color: green; ">#  ターゲットコホートとコンパレータコホートの指標日前後の時間経過に伴うイベント数をプロットします。</span>
plotTimeToEvent(cohortMethodData = cohortMethodData,
        outcomeId = 3,
        firstExposureOnly = FALSE,
        washoutPeriod = 0,
        removeDuplicateSubjects = FALSE,
        minDaysAtRisk = 1,
        riskWindowStart = 0,
        startAnchor = &quot;cohort start&quot;,
        riskWindowEnd = 30,
        endAnchor = &quot;cohort end&quot;)
</div></code></pre>
<br>
<p>上記を実行すると、R コンソール上に以下のようなグラフが描画されます。<br>
<img src=".\HADES_2/image/image19.png" alt="" width="800px"></p>
<br>
<br>
<br>
<br>
<br>
</body>
</html>
